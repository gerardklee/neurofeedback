<!DOCTYPE HTML>
<html>
    <head>
        <title>Neurofeedback</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    </head>
    <body>
        <div id="background">
                <button type="button" class="fa fa-users" style="font-size:48px" id="brain"></button>
        </div>
        <br>
        <div id="sound">
            <button type="button" class="fa fa-volume-up" style="font-size:48px" id="sound-on"></button>
            <button type="button" class="fa fa-volume-off" style="font-size:48px" id="sound-off"></button>
        </div>
        <br>
        <div id="charts">
            <button type="button" class="fa fa-bar-chart" style="font-size:48px" id="bar"></button>
            <button type="button" class="fa fa-line-chart" style="font-size:48px" id="line"></button>
            <button type="button" class="fa fa-pie-chart" style="font-size:48px" id="pie"></button>
        </div>
        <br>
        <div>
            <canvas id="barChart" style="display: none"></canvas>
            <canvas id="lineChart" style="display: none"></canvas>
            <canvas id="pieChart" style="display: none"></canvas>
            <canvas id="sound"><</canvas>
        </div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.4/socket.io.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3"></script>
        <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/SoundJS/1.0.2/soundjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.5.35/Tone.js"></script>
        <script>
            $(document).ready(function() {
                $("#bar").click(function() {
                    $("#bar").css({"font-size": "60px"});
                    $("#line").css({"font-size": "48px"});
                    $("#pie").css({"font-size": "48px"});
                    $("#sound-on").css({"font-size": "48px"});
                    $("#sound-off").css({"font-size": "48px"});
                    $("#barChart").show();
                    $("#lineChart").hide();
                    $("#pieChart").hide();

                });

                $("#line").click(function() {
                    $("#bar").css({"font-size": "48px"});
                    $("#line").css({"font-size": "60px"});
                    $("#pie").css({"font-size": "48px"});
                    $("#sound-on").css({"font-size": "48px"});
                    $("#sound-off").css({"font-size": "48px"});
                    $("#lineChart").show();
                    $("#barChart").hide();
                    $("#pieChart").hide();
                });

                $("#pie").click(function() {
                    $("#bar").css({"font-size": "48px"});
                    $("#line").css({"font-size": "48px"});
                    $("#pie").css({"font-size": "60px"});
                    $("#sound-on").css({"font-size": "48px"});
                    $("#sound-off").css({"font-size": "48px"});
                    $("#lineChart").show();
                    $("#barChart").hide();
                    $("#pieChart").hide();
                });

                $("#brain").click(function() {
                    $("#bar").css({"font-size": "48px"});
                    $("#line").css({"font-size": "48px"});
                    $("#pie").css({"font-size": "48px"});
                    $("#sound-on").css({"font-size": "48px"});
                    $("#sound-off").css({"font-size": "48px"});
                    $("#lineChart").hide();
                    $("#barChart").hide();
                    $("#pieChart").hide();
                    
                });

                $("#sound-on").click(function() {
                    $("#bar").css({"font-size": "48px"});
                    $("#line").css({"font-size": "48px"});
                    $("#pie").css({"font-size": "48px"});
                    $("#sound-on").css({"font-size": "60px"});
                    $("#sound-off").css({"font-size": "48px"});
                    playMusic();
                });

                $("#sound-off").click(function() {
                    $("#bar").css({"font-size": "48px"});
                    $("#line").css({"font-size": "48px"});
                    $("#pie").css({"font-size": "48px"});
                    $("#sound-on").css({"font-size": "48px"});
                    $("#sound-off").css({"font-size": "60px"});
                    stopMusic();
                });
            });

            var socket = io('http://localhost:3000');
            var ctx = document.getElementById('barChart').getContext('2d');

            // BAR CHART USING CHART
            var barChartData = {
                labels: [],
                datasets: [
                    {
                        label: '7Hz',
                        backgroundColor: '#AF7', // lime green
                        borderWidth: 5,
                        data: []
                    },                        {
                        label: '7.25Hz',
                        backgroundColor: '#AF7',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '7.5Hz',
                        backgroundColor: '#AF7',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '7.75Hz',
                        backgroundColor: '#AF7',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '8Hz',
                        backgroundColor: '#9400D3', // purple
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '8.25Hz',
                        backgroundColor: '#9400D3',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '8.5Hz',
                        backgroundColor: '#9400D3',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '8.75Hz',
                        backgroundColor: '#9400D3',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '9Hz',
                        backgroundColor: '#00FFFF', // sky blue
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '9.25Hz',
                        backgroundColor: '#00FFFF',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '9.5Hz',
                        backgroundColor: '#00FFFF',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '9.75Hz',
                        backgroundColor: '#00FFFF',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '10Hz',
                        backgroundColor: '#0000A0', // blue
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '10.25Hz',
                        backgroundColor: '#0000A0',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '10.5Hz',
                        backgroundColor: '#0000A0',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '10.75Hz',
                        backgroundColor: '#0000A0',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '11Hz',
                        backgroundColor: '#FFFF00', // yellow
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '11.25Hz',
                        backgroundColor: '#FFFF00',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '11.5Hz',
                        backgroundColor: '#FFFF00',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '11.75Hz',
                        backgroundColor: '#FFFF00',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '12Hz',
                        backgroundColor: '#008000', // green
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '12.25Hz',
                        backgroundColor: '#008000', 
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '12.5Hz',
                        backgroundColor: '#008000',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '12.75Hz',
                        backgroundColor: '#008000',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '13Hz',
                        backgroundColor: '#FFA500', // orange
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '13.25Hz',
                        backgroundColor: '#FFA500', 
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '13.5Hz',
                        backgroundColor: '#FFA500',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '13.75Hz',
                        backgroundColor: '#FFA500',
                        borderWidth: 5,
                        data: []
                    }
                ]
            };

            var barChart = new Chart(ctx, {
                type: 'bar',
                data: barChartData,
                options: {
                    title: {
                        display: false,
                        text: "Bar Chart",
                        fontSize: 14,
                        fontFamily: 'Arial',
                        fontColor: '#FF0000'
                    },

                    legend: {
                        display: false
                    }
                }
            });

            /**
            // LINE CHART USING D3
            var n      = 40,
                random = d3.randomNormal(5, 10),
                //data   = d3.range(n).map(random);
                data = [16, 17, 18, 19, 20, 16.5, 17.5, 18, 19, 18.5];
            
            console.log(data);
            var step = 10;

            var margin = {top: 50, right: 50, bottom: 50, left: 50},
                globalX = 0,
                width = 960 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

            var xScale = d3.scaleLinear()
                    .domain([0, n - 1]) // input should be between minimum value to maximum value in dataset
                    .range([0, width]); // when the input is the max value from the data, it outputs width

            var yScale = d3.scaleLinear()
                    .domain([d3.min(data), d3.max(data)])
                    .range([height, 0]);

        
            var line = d3.line()
                    .x(function(d, i) { return xScale(i); })
                    .y(function(d, i) { return yScale(d); })
                    .curve(d3.curveMonotoneX);

            var canvas = d3.select("body").append("svg")
                                        .attr("width", width + margin.left + margin.right)
                                        .attr("height", height + margin.top + margin.bottom)
                                        .append("g")
                                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");                      
             
            // set the canvas to draw
            canvas.append("defs").append("clipPath")
                                .attr("id", "clip")
                                .append("rect")
                                .attr("width", width)
                                .attr("height", height);
            
            // manipulate x-axis
            canvas.append("g")
                  .attr("class", "x axis")
                  .attr("transform", "translate(0, " + height + ")")
                  .call(d3.axisBottom(xScale)); // create axis on the bottom given the scale for x-axis

            // manipulate y-axis
            canvas.append("g")
                  .attr("class", "y axis")
                  .call(d3.axisLeft(yScale)); // create axis on the left given the scale for y-axis

            // path is filled by default. set the fill to none and stroke to black to get rid of fill.
            var path = canvas.append("g")
                            .append("path")
                            .attr("fill", "none")
                            .attr("stroke", "black")
                            .data([data]);
            **/

            // LINE CHART USING CHART.JS
            var ctx2 = document.getElementById('lineChart').getContext('2d');
            var counter = 0;
            Chart.defaults.global.animation.duration = 50;
            var lineChart = new Chart(ctx2, {
                type: 'line',
                data: {datasets: [{
                    label: "Average Alpha Wave",
                    data: []
                }]},
                options: {
                    title: {
                        display: false,
                        text: "Line Chart",
                        fontSize: 14,
                        fontFamily: 'Arial',
                        fontColor: '#FF0000'
                    },

                    legend: {
                        display: false
                    }
                }
            });

            // FEEDBACK USING TONE.JS
            // USE PLAYER, PLAYBACK RATE
            /**
            var player = new Tone.Player({
                "url": "https://raw.githubusercontent.com/Tonejs/Tone.js/master/examples/audio/FWDL.mp3",
                "playbackRate": 1.5,
                "loop": true,
                "autostart": true,
                "loopStart": 0,
                "loopEnd": 0
            });
            **/

            mockData = [];
            var player = new Tone.Oscillator({
                type: "sine",
                frequency: 200,
                volume: 5,
                mute: false
            });
            var now = Tone.now();
            var maxFrequency = 400;
            var minFrequency = 50;

            socket.on('fft_data', function(fft_data) {
                //updateBarChart(barChart, fft_data);
                //updateLineChart2(lineChart, fft_data);
                //console.log(fft_data.psd[0][0]);

                //console.log(fft_data.psd[0][0]);
                //playMusic();

            });  

            // FUNCTIONS FOR SOUND
            function playMusic() {
                //console.log(player.get());
                mockData.push(Math.random() * 10);
                player.mute = false;
                player
                    .toDestination()
                    .start(now += 0.0001);  
                console.log(now);      
            }

            function stopMusic() {
                console.log("stop");
                player.mute = true;
            }

            // FUNCTIONS FOR BAR CHART
            function updateBarChart(barChart, fft_data) {
                for (var i = 0; i < barChart.data.datasets.length; i++) {
                    barChart.data.datasets[i].data[0] = fft_data.psd[0][i];
                }
                barChart.update();
            }

            // FUNCTIONS FOR LINE CHART
            function updateLineChart(fft_data) {
                var averageAlpha = getAlphaAverage(fft_data.psd[0]);
                data.push(averageAlpha);
                path.attr("d", line)
                    .attr("transform", null)
                    .transition()
                    .duration(100)
                    .ease(d3.easeLinear)
                    .attr("transform", "translate(" + xScale(-1) + ",0)")
                data.shift();
            }

            function getAlphaAverage(fft_data) {
                var total = 0;
                var average = 0;
                var totalNumberofFrequencies = 28;
                for (var i = 0; i < fft_data.psd[0].length; i++) {
                    total += fft_data.psd[0][i];
                }
                average = total / totalNumberofFrequencies;
                return average;
            }

            // FUNCTIONS FOR LINE CHART (CHART.JS)
            function updateLineChart2(lineChart, fft_data) {
                var averageAlpha = getAlphaAverage(fft_data);
                var length = 100;
                //console.log(lineChart.data.datasets[0].data);
                if (lineChart.data.datasets[0].data.length == length) {
                    lineChart.data.datasets[0].data.shift();
                    lineChart.data.labels.shift();
                }
                lineChart.data.datasets[0].data.push(Math.random() * 10);
                lineChart.data.labels.push(counter++);
                lineChart.update();
            }
        </script>
    </body>   
</html>