<!DOCTYPE HTML>

<html>
    <head>
        <title>Neurofeedback</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">    
        <link href="style.css" type="text/css" rel="stylesheet">
    </head>
    <body class="page">
        <div id="background">
            <button type="button" class="fa fa-users" style="font-size:20px" id="brain"></button>
            <button type="button" class="fa fa-volume-up" style="font-size:20px" id="sound-on"></button>
            <button type="button" class="fa fa-volume-off" style="font-size:20px" id="sound-off"></button>
            <button type="button" class="fa fa-bar-chart" style="font-size:20px" id="bar"></button>
            <button type="button" class="fa fa-area-chart" style="font-size:20px" id="line"></button>
            <button type="button" class="fa fa-pie-chart" style="font-size:20px" id="pie"></button>
            <button type="button" class="fa fa-line-chart" style="font-size:20px" id="raw"></button>
            <i class="fa fa-spinner fa-spin" style="font-size:40px" id="loading-icon"></i>
            <i class="fa fa-cog fa-spin" style="font-size:40px" id="extracting-icon"></i>
            <i class="fa fa-check" style="font-size:40px" id="ready-icon"></i>
        </div>
        <div class="slideContainer">
            <br>
            <p>Value: <span id="value"></span></p>
            <input type="range" min="1" max="100" value="1" id="myRange" class="slider">
        </div>
        <br>
        <div>
            <canvas id="barChart" height=50 style="display: none"></canvas>
            <canvas id="lineChart" height=50 style="display: none"></canvas>
            <canvas id="pieChart" height=50 style="display: none"></canvas>
            <canvas id="rawChart" height=50 style="display: none"></canvas>
        </div>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.4/socket.io.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js@2.9.3"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/SoundJS/1.0.2/soundjs.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.5.38/Tone.js"></script>
        <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
        <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js" integrity="sha256-VazP97ZCwtekAsvgPBSUwPFKdrwD3unUfSGVYrahUqU=" crossorigin="anonymous"></script>
        
        <script>
            $(document).ready(function() {
                $("#loading-icon").hide();
                $("#extracting-icon").hide();
                $("#ready-icon").hide();
                $("#bar").click(function() {
                    $("#bar").css({"font-size": "30px"});
                    $("#line").css({"font-size": "20px"});
                    $("#pie").css({"font-size": "20px"});
                    $("#sound-on").css({"font-size": "20px"});
                    $("#sound-off").css({"font-size": "20px"});
                    $("#raw").css({"font-size": "20px"});
                    $("#barChart").show();
                    $("#lineChart").hide();
                    $("#pieChart").hide();
                    $("#rawChart").hide();

                });

                $("#line").click(function() {
                    $("#bar").css({"font-size": "20px"});
                    $("#line").css({"font-size": "30px"});
                    $("#pie").css({"font-size": "20px"});
                    $("#sound-on").css({"font-size": "20px"});
                    $("#sound-off").css({"font-size": "20px"});
                    $("#raw").css({"font-size": "20px"});
                    $("#lineChart").show();
                    $("#barChart").hide();
                    $("#pieChart").hide();
                    $("#rawChart").hide();
                });

                $("#pie").click(function() {
                    $("#bar").css({"font-size": "20px"});
                    $("#line").css({"font-size": "20px"});
                    $("#pie").css({"font-size": "30px"});
                    $("#sound-on").css({"font-size": "20px"});
                    $("#sound-off").css({"font-size": "20px"});
                    $("#raw").css({"font-size": "20px"});
                    $("#lineChart").hide();
                    $("#barChart").hide();
                    $("#pieChart").show();
                    $("#rawChart").hide();
                });

                $("#raw").click(function() {
                    $("#bar").css({"font-size": "20px"});
                    $("#line").css({"font-size": "20px"});
                    $("#pie").css({"font-size": "20px"});
                    $("#sound-on").css({"font-size": "20px"});
                    $("#sound-off").css({"font-size": "20px"});
                    $("#raw").css({"font-size": "30px"});
                    $("#lineChart").hide();
                    $("#barChart").hide();
                    $("#pieChart").hide();
                    $("#rawChart").show();
                });

                $("#brain").click(function() {
                    $("#bar").css({"font-size": "20px"});
                    $("#line").css({"font-size": "20px"});
                    $("#pie").css({"font-size": "20px"});
                    $("#sound-on").css({"font-size": "20px"});
                    $("#sound-off").css({"font-size": "20px"});
                    $("#raw").css({"font-size": "20px"});
                    $("#lineChart").hide();
                    $("#barChart").hide();
                    $("#pieChart").hide();
                    $("#rawChart").hide();
                    
                });

                $("#sound-on").click(function() {
                    $("#bar").css({"font-size": "20px"});
                    $("#line").css({"font-size": "20px"});
                    $("#pie").css({"font-size": "20px"});
                    $("#sound-on").css({"font-size": "30px"});
                    $("#sound-off").css({"font-size": "20px"});
                    $("#raw").css({"font-size": "20px"});
                    //playMusic();
                });

                $("#sound-off").click(function() {
                    $("#bar").css({"font-size": "20px"});
                    $("#line").css({"font-size": "20px"});
                    $("#pie").css({"font-size": "20px"});
                    $("#sound-on").css({"font-size": "20px"});
                    $("#sound-off").css({"font-size": "30px"});
                    $("#raw").css({"font-size": "20px"});
                    stopMusic();
                });
            });

            var socket = io('http://localhost:3000');
            var ctx = document.getElementById('barChart').getContext('2d');
            ctx.borderWidth = 300;
            ctx.borderHeight = 300;
            // BAR CHART USING CHART
            var barChartData = {
                labels: [],
                datasets: [
                    {
                        label: '7.5Hz',
                        backgroundColor: '#AF7',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '7.75Hz',
                        backgroundColor: '#AF7',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '8Hz',
                        backgroundColor: '#9400D3', // purple
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '8.25Hz',
                        backgroundColor: '#9400D3',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '8.5Hz',
                        backgroundColor: '#9400D3',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '8.75Hz',
                        backgroundColor: '#9400D3',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '9Hz',
                        backgroundColor: '#00FFFF', // sky blue
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '9.25Hz',
                        backgroundColor: '#00FFFF',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '9.5Hz',
                        backgroundColor: '#00FFFF',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '9.75Hz',
                        backgroundColor: '#00FFFF',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '10Hz',
                        backgroundColor: '#0000A0', // blue
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '10.25Hz',
                        backgroundColor: '#0000A0',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '10.5Hz',
                        backgroundColor: '#0000A0',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '10.75Hz',
                        backgroundColor: '#0000A0',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '11Hz',
                        backgroundColor: '#FFFF00', // yellow
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '11.25Hz',
                        backgroundColor: '#FFFF00',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '11.5Hz',
                        backgroundColor: '#FFFF00',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '11.75Hz',
                        backgroundColor: '#FFFF00',
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '12Hz',
                        backgroundColor: '#008000', // green
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '12.25Hz',
                        backgroundColor: '#008000', 
                        borderWidth: 5,
                        data: []
                    },
                    {
                        label: '12.5Hz',
                        backgroundColor: '#008000',
                        borderWidth: 5,
                        data: []
                    }
                ]
            };

            var barChart = new Chart(ctx, {
                type: 'bar',
                data: barChartData,
                options: {
                    title: {
                        display: false,
                        text: "Bar Chart",
                        fontSize: 14,
                        fontFamily: 'Arial',
                        fontColor: '#FF0000'
                    },

                    legend: {
                        display: false
                    }, 

                    scales: {
                        yAxes: [{
                            ticks: {
                                min: 0,
                                max: 6,
                                stepsize: 0.1
                            }
                        }]
                    }       
                }
            });

            /**
            // LINE CHART USING D3
            var n      = 40,
                random = d3.randomNormal(5, 10),
                //data   = d3.range(n).map(random);
                data = [16, 17, 18, 19, 20, 16.5, 17.5, 18, 19, 18.5];
            
            console.log(data);
            var step = 10;

            var margin = {top: 50, right: 50, bottom: 50, left: 50},
                globalX = 0,
                width = 960 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

            var xScale = d3.scaleLinear()
                    .domain([0, n - 1]) // input should be between minimum value to maximum value in dataset
                    .range([0, width]); // when the input is the max value from the data, it outputs width

            var yScale = d3.scaleLinear()
                    .domain([d3.min(data), d3.max(data)])
                    .range([height, 0]);

        
            var line = d3.line()
                    .x(function(d, i) { return xScale(i); })
                    .y(function(d, i) { return yScale(d); })
                    .curve(d3.curveMonotoneX);

            var canvas = d3.select("body").append("svg")
                                        .attr("width", width + margin.left + margin.right)
                                        .attr("height", height + margin.top + margin.bottom)
                                        .append("g")
                                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");                      
             
            // set the canvas to draw
            canvas.append("defs").append("clipPath")
                                .attr("id", "clip")
                                .append("rect")
                                .attr("width", width)
                                .attr("height", height);
            
            // manipulate x-axis
            canvas.append("g")
                  .attr("class", "x axis")
                  .attr("transform", "translate(0, " + height + ")")
                  .call(d3.axisBottom(xScale)); // create axis on the bottom given the scale for x-axis

            // manipulate y-axis
            canvas.append("g")
                  .attr("class", "y axis")
                  .call(d3.axisLeft(yScale)); // create axis on the left given the scale for y-axis

            // path is filled by default. set the fill to none and stroke to black to get rid of fill.
            var path = canvas.append("g")
                            .append("path")
                            .attr("fill", "none")
                            .attr("stroke", "black")
                            .data([data]);
            **/

            // LINE CHART USING CHART.JS
            var ctx2 = document.getElementById('lineChart').getContext('2d');
            var counter = 0;
            Chart.defaults.global.animation.duration = 50;
            var lineChart = new Chart(ctx2, {
                type: 'line',
                data: {datasets: [{
                    label: "Average Alpha Wave",
                    data: []
                }]},
                options: {
                    title: {
                        display: false,
                        text: "Line Chart",
                        fontSize: 14,
                        fontFamily: 'Arial',
                        fontColor: '#FF0000'
                    },

                    legend: {
                        display: false
                    },

                    scales: {
                        yAxes: [{
                            ticks: {
                                min: 0,
                                max: 5,
                                stepsize: 0.5
                            }
                        }]
                    }
                }
            });

            // BAR CHART USING CHART.JS
            var ctx3 = document.getElementById('pieChart').getContext('2d');
            var tracker = 1;
            var pieChart = new Chart(ctx3, {
                type: 'doughnut',
                data: {
                    labels: ['7.5Hz', '7.75HZ', '8Hz', '8.25Hz', 
                             '8.5Hz', '8.75HZ', '9Hz', '9.25Hz', 
                             '9.5Hz', '9.75HZ', '10Hz', '10.25Hz', 
                             '10.5Hz', '10.75HZ', '11Hz', '11.25Hz', 
                             '11.5Hz', '11.75HZ', '12Hz', '12.25Hz', 
                             '12.5Hz'],
                    datasets: [{
                        //data: [1, 2, 3, 4, 5, 6, 7,
                               //8, 9, 10, 11, 12, 13, 14,
                               //15, 16, 17, 18, 19, 20, 21,
                               //22, 23, 24, 25, 26, 27, 28],
                        data: [],
                        backgroundColor: ['#663300', '#FF8000', '#FFE5CC', '#333300', '#666600', 
                                          '#999900', '#FFFF00', '#66CC00', '#006666', '#00FFFF', '#003366', '#0080FF',
                                          '#99CCFF', '#0000CC', '#6600CC', '#9933FF', '#CC00CC', '#FF99FF', '#CC0066',
                                          '#FF99CC', '#000000'],
                        borderWidth: 0.5,
                        borderColor: '#ddd'
                    }]
                },
                options: {
                    title: {
                        display: true
                    }
                }
            });

            // LINE CHART FOR RAW DATA
            var ctx4 = document.getElementById('rawChart').getContext('2d');
            var counter = 0;
            Chart.defaults.global.animation.duration = 50;
            var rawChart = new Chart(ctx4, {
                type: 'line',
                data: {datasets: [{
                    label: "Raw Data",
                    data: []
                }]},
                options: {
                    title: {
                        display: false,
                        text: "Raw Chart",
                        fontSize: 14,
                        fontFamily: 'Arial',
                        fontColor: '#FF0000'
                    },

                    legend: {
                        display: false
                    },

                    scales: {
                        yAxes: [{
                            ticks: {
                                min: -60000,
                                max: 0,
                                stepsize: 0.5
                            }
                        }]
                    }
                }
            });

            // FEEDBACK USING TONE.JS

            // player below uses beep.
            // intended to control the frequency of the beep based on alpha waves.
            var player = new Tone.Oscillator({
                type: "sine",
                frequency: 500,
                volume: -50,
                mute: false
            });

            var now = Tone.now();
            var maxFrequency = 150;
            var minFrequency = 50;

            var slider = document.getElementById("myRange");
            var output = document.getElementById("value");
            
            var current = 1;
            var before = 0;
            var maxVolume = 5;
            var minVolume = -50;

            // multiplayer below stacks instruments
            // once you go above certain values of alpha frequency,
            // specific instruments stack up and play.
            // for example, guitar -> bass -> saxophone -> etc.
            // if your meditation works really good, some 'bonus' sound will be added.
            var loopStart = 0;
            var loopEnd = 0;
            var cello = new Tone.Player({
                "url": "http://localhost:3000/music/cellos.mp3",
                "playbackRate": 1.0,
                "mute": false,
                "loop": true,
                "loopStart": loopStart,
                "loopEnd": loopEnd
            });

            var percussion = new Tone.Player({
                "url": "http://localhost:3000/music/percussion.mp3",
                "playbackRate": 1.0,
                "mute": false,
                "loop": true,
                "loopStart": loopStart,
                "loopEnd": loopEnd
            });

            var ensemble = new Tone.Player({
                "url": "http://localhost:3000/music/ensemble.mp3",
                "playbackRate": 1.0,
                "mute": false,
                "loop": true,
                "loopStart": loopStart,
                "loopEnd": loopEnd
            });

            var choir = new Tone.Player({
                "url": "http://localhost:3000/music/choir.mp3",
                "playbackRate": 1.0,
                "mute": false,
                "loop": true,
                "loopStart": loopStart,
                "loopEnd": loopEnd
            });

            var viola = new Tone.Player({
                "url": "http://localhost:3000/music/viola.mp3",
                "playbackRate": 1.0,
                "mute": false,
                "loop": true,
                "loopStart": loopStart,
                "loopEnd": loopEnd
            });

            var sitar = new Tone.Player({
                "url": "http://localhost:3000/music/sitar.mp3",
                "playbackRate": 1.0,
                "mute": false,
                "loop": true,
                "loopStart": loopStart,
                "loopEnd": loopEnd
            });

            var violin = new Tone.Player({
                "url": "http://localhost:3000/music/violin.mp3",
                "playbackRate": 1.0,
                "mute": false,
                "loop": true,
                "loopStart": loopStart,
                "loopEnd": loopEnd
            });

            //var multiplayer = [cello, percussion, ensemble, choir, viola, sitar, violin];
            var multiplayer = [cello, ensemble, percussion];

            // using only the theme, use playbackRate as the feedback.
            var theme = new Tone.Player({
                "url": "http://localhost:3000/music/theme.mp3",
                "playbackRate": 0,
                "mute": false,
                "loop": true,
                "loopStart": loopStart,
                "loopEnd": loopEnd
            });
            
            const startTime = Date.now();
            var timeElapsed = 0;
            var timeForStabilizing = 60000; // 60000 for 1 minute.
            var timeForMaxFreq = 200000; // 200000 for 3 minutes.
            var maxSpeed = 1;
            var minSpeed = 0;
            var maxFreqIndex = 0;
            var minFreqIndex = 0;
            var maxVal = 0;
            var themeFlag = false;
            var loading = false;
            var extractingAPF = false;
            var valuesPushed = false;
            var ready = false;

            // calculating EMA
            var EMAarr = [];
            var SMAarr = [];

            // keys represent index of the fftData.psd[0].
            // the actual frequency for each index = 7.5 + index * 0.25.
            // for example, 7.5 + 1 * 0.25 = 7.75.
            var freqsMap = {'0': [], '1': [], '2': [], '3': [],
                            '4': [], '5': [], '6': [], '7': [],
                            '8': [], '9': [], '10': [], '11': [],
                            '12': [], '13': [], '14': [], '15': [],
                            '16': [], '17': [], '18': [], '19': [],
                            '20': []};
            const period = 100;
            var prevEMAVal = 0;
            var smoothingConstant = 0.1;
            var scaleVal = 0;

            // letting the user know what frequency with text-to-speech
            var msg = new SpeechSynthesisUtterance('');

            // CHECK IF THE RAW DATA IS GOOD
            $("#raw").click(function() {
                socket.on('rawData', function(rawData) {
                    updateRawChart(rawChart, rawData);
                });
            });

            // GET DATA FROM THE SERVER
            // alpha range is gray channel and eye blink is purple channel.
            $("#sound-on").click(function() {
                socket.on('fftData', function(fftData) {
                    timeElapsed = Date.now() - startTime;

                    // run the device for about a minute to stabilize the data.
                    if (timeElapsed > 0 && timeElapsed < timeForStabilizing) {
                        if (loading === false) {
                            loading = true;
                            $("#loading-icon").show();
                        }

                    // once stabilized, have the user close his/her eyes and 
                    // run the device for about 3 minutes to extract the alpha
                    // peak frequency index.
                    } else if (timeElapsed > timeForStabilizing && timeElapsed < timeForMaxFreq) {
                        if (loading === true) {
                            loading = false;
                            $("#loading-icon").hide();
                        }
                        if (extractingAPF === false) {
                            extractingAPF = true;
                            msg.text = "extracting your alpha peak frequency. Please close your eyes for 3 minutes";
                            //msg.text = "extracting your alpha minimum frequency. Please close your eyes for 3 minutes";
                            window.speechSynthesis.speak(msg);
                            $("#extracting-icon").show();
                        }
                        pushValstoFreqsMap(fftData, freqsMap);

                    // once alpha peak frequency is obtained, use that value to calculate EMA
                    // and provide sound feedback based on the EMA values.
                    // tell the user to close eyes, tell the user to do movements.
                    // get low and high and finally, get the mid value for the calibration value.
                    } else {
                        if (valuesPushed === false) {
                            valuesPushed = true;

                            getMaxFrequencyIndex(fftData, freqsMap); // update the maxFrequencyIndex.
                            //getMinFrequencyIndex(fftData, freqsMap); // update the minFrequencyIndex.

                        }
                        if (SMAarr.length < period) {
                            SMAarr.push(fftData.psd[0][maxFreqIndex]);
                            //SMAarr.push(fftData.psd[0][minFreqIndex]);
                            
                        } 
                        // insert the first EMA value to the EMAarr.
                        if (SMAarr.length === period - 1 && EMAarr.length === 0) {

                            SMAarr.push(fftData.psd[0][maxFreqIndex]);
                            //SMAarr.push(fftData.psd[0][minFreqIndex]);

                            var firstEMAVal = getFirstEMAVal(SMAarr, period);
                            EMAarr.push(firstEMAVal);
                            //smoothingConstant = getSmoothingConstant(period);
                        }

                        if (EMAarr.length > 0) {
                            //console.log("EMA: ", EMAarr[EMAarr.length - 1]);
                            if (extractingAPF === true) {
                                extractingAPF = false;
                                $("#extracting-icon").hide();
                            }
                            if (ready === false) {
                                ready = true;
                                $("#ready-icon").show();

                                const APF = 7.5 + maxFreqIndex * 0.25;
                                //const AMF = 7.5 + minFreqIndex * 0.25;
                                var beforeDecimal = []
                                var afterDecimal = []
                                var dotTracker = 0;

                                if (APF.toString().includes(".")) {
                                    for (var i = 0; i < APF.toString().length; i++) {
                                        if (APF.toString()[i] === ".") {
                                            dotTracker = i;
                                        }
                                    }
                                    for (var i = 0; i < dotTracker; i++) {
                                        beforeDecimal.push(APF.toString()[i]);
                                    }
                                    for (var i = dotTracker + 1; i < APF.toString().length; i++) {
                                        afterDecimal.push(APF.toString()[i]);
                                    }
                                    msg.text = beforeDecimal.join('') * 1 + "point";
                                    window.speechSynthesis.speak(msg);
                                    msg.text = afterDecimal.join('') * 1;
                                    window.speechSynthesis.speak(msg); 
                                } else {
                                    msg.text = APF;
                                    window.speechSynthesis.speak(msg);
                                }               
                            }
                            
                            // if first EMAVal is set and themeFlag is true, then start providing
                            // feedback!
                            if (themeFlag === false) {
                                themeFlag = true;
                                setTimeout(function() {
                                    playTheme();
                                }, 6000);
                            } else {
                                prevEMAVal = EMAarr[EMAarr.length - 1];

                                var feedbackInput = getEMA(fftData.psd[0][maxFreqIndex], prevEMAVal, smoothingConstant);
                                //var feedbackInput = getEMA(fftData.psd[0][minFreqIndex], prevEMAVal, smoothingConstant);

                                provideRegularFeedback(feedbackInput);
                                EMAarr.push(feedbackInput);
                                updateMaxFreqLineChart(lineChart, fftData);
                                updateBarChart(barChart, fftData, freqsMap);
                            }
                        }
                    }
                });
            });


            // FUNCTIONS FOR SOUND FEEDBACK
            /**
             * Provides sound-feedback based on the calculated Exponential Moving Average values
             * 
             * @param {Number} feedbackInput The most recent EMA value
             **/
            function provideRegularFeedback(feedbackInput) {
                var tempPlayRate = 1 + (feedbackInput - 2) / 2;
                if (tempPlayRate > 1) {
                    theme.playbackRate = 1;
                } else if (tempPlayRate < 0) {
                    theme.playbackRate = 0;
                } else {
                    theme.playbackRate = tempPlayRate;
                }
            }

            /**
             *  Provides sound-feedback using stack of instruments (cellos, violin, etc) based on the
             *  calculated Exponential Moving Average values
             * 
             *  @param {Number} feedbackInput Last EMA value
             **/
            function providedStackFeedback(feedbackInput) {
                return;
            }

            /**
             * Get the index of max frequency from fftData.psd[0]
             * 
             * @param {Object} fftData The object that contains fft data from OpenBCI-Wifi device
             **/
            function getMaxIndex(fftData) {
                if (maxVal === 0) {
                    maxVal = fftData.psd[0][0];
                }

                for (var i = 0; i < fftData.psd[0].length; i++) {
                    if (fftData.psd[0][i] > maxVal) {
                        console.log("here: ", fftData.psd[0][i]);
                        maxFreqIndex = i;
                        maxVal = fftData.psd[0][i];
                    }
                }
            }

            /**
             * Plays the song for the regular feedback
             * 
             **/
            function playTheme() {
                theme.toDestination().start();
            }

            /**
             * Stops the song for the regular feedback
             * 
             **/
            function stopTheme()  {
                theme.mute = true;
            }

            /**
             * Plays the music for the stack feedback
             * 
             **/
            function playMultiPlayer() {
                for (var instrument = 0; instrument < multiplayer.length; instrument++) {
                    multiplayer[instrument].toDestination().start();
                }
            }

            /**
             * Stops the music for the stack feedback
             * 
             **/
            function stopMultiPlayer() {
                console.log("stop music");
                for (var instrument = 0; instrument < multiplayer.length; instrument++) {
                    multiplayer[instrument].mute = true;
                }
            }

            /**
             * Plays the beep for the regular feedback and allows the volume controller to change volume
             * 
             **/
            // use jquery .change()
            function playBeep() {
                // changing volume
                player.toDestination().start();
                var optimalVolumeUpDownVal = 0.63;
                output.innerHTML = slider.value;
                slider.oninput = function() {
                    output.innerHTML = this.value;
                    if (this.value > current) {
                        player.volume.value += optimalVolumeUpDownVal;
                        if (player.volume.value > maxVolume) {
                            player.volume.value = maxVolume;
                        }
                        before = current;
                        current = this.value;
                    } else if (this.value < current) {
                        player.volume.value -= optimalVolumeUpDownVal;
                        if (player.volume.value < minVolume) {
                            player.volume.value = minVolume;
                        }
                        before = current;
                        current = this.value;
                    }
                }                   
            }

            /**
             * Stops the beep for the regular feedback
             * 
             **/
            function stopBeep() {
                player.mute = true;
            }

            // FUNCTIONS FOR BAR CHART
            /**
             * Plots the bar chart with bins of the range between 7.5Hz and 12.5Hz
             * 
             * @param {Object} barChart The properties of the bar chart
             * @param {Object} fftData The object that contains fft data from OpenBCI-Wifi device
             **/
            function updateBarChart(barChart, fftData, freqsMap) {
                var averagesArray = [];
                for (var i = 0; i < barChart.data.datasets.length; i++) {
                    freqsMap[i.toString()].shift();
                }

                pushValstoFreqsMap(fftData, freqsMap);

                for (var i = 0; i < barChart.data.datasets.length; i++) {
                    var total = freqsMap[i.toString()].reduce((a, b) => a + b, 0);
                    var average = total / freqsMap[i.toString()].length;
                    averagesArray.push(average); 
                }

                for (var i = 0; i < averagesArray.length; i++) {
                    barChart.data.datasets[i].data[0] = averagesArray[i];
                }
                barChart.update();
            }

            // FUNCTIONS FOR LINE CHART (D3.JS)
            function updateLineChart(fftData) {
                var averageAlpha = getAlphaWaves(fftData.psd[0]);
                data.push(averageAlpha);
                path.attr("d", line)
                    .attr("transform", null)
                    .transition()
                    .duration(100)
                    .ease(d3.easeLinear)
                    .attr("transform", "translate(" + xScale(-1) + ",0)")
                data.shift();
            }

            // FUNCTIONS FOR LINE CHART (CHART.JS)
            /**
             * Plots the line chart with the raw data in microvolts
             * 
             * @param {Object} lineChart The properties of the line chart
             * @param {Object} fftData The object that contains fft data from OpenBCI-Wifi device
             **/
            function updateLineChartRaw(lineChart, fftData) {
                var length = 100;
                if (lineChart.data.datasets[0].data.length > length) {
                    lineChart.data.datasets[0].data.shift();
                    lineChart.data.labels.shift();
                }
                lineChart.data.datasets[0].data.push(fftData.data[0]);
                lineChart.data.labels.push(counter++);
                lineChart.update();
            }

            /**
             * Plots the line chart with the alpha waves which is the average of the frequencies between
             * 7.5Hz and 12.5Hz
             * 
             * @param {Object} lineChart The properties of the line chart
             * @param {Object} fftData The object that contains fft data from OpenBCI-Wifi device
             **/
            function updateAverageLineChart(lineChart, fftData) {
                var averageAlpha = getAlphaWaves(fftData);
                var tempVal = fftData.psd[0][0];
                var length = 100;
                var randomVal = Math.random() * 10;

                if (lineChart.data.datasets[0].data.length > length) {
                    lineChart.data.datasets[0].data.shift();
                    lineChart.data.labels.shift();
                }
                lineChart.data.datasets[0].data.push(averageAlpha);
                lineChart.data.labels.push(counter++);
                lineChart.update();
            }

            /**
             * Plots the line chart with the most recent EMA value
             * 
             * @param {Object} lineChart The properties of the line chart
             * @param {Object} fftData The object that contains fft data from OpenBCI-Wifi device
             **/
            function updateMaxFreqLineChart(lineChart, fftData) {
                var length = 100;

                if (lineChart.data.datasets[0].data.length > length) {
                    lineChart.data.datasets[0].data.shift();
                    lineChart.data.labels.shift();
                }
                lineChart.data.datasets[0].data.push(EMAarr[EMAarr.length - 1]);
                lineChart.data.labels.push(counter++);
                lineChart.update();
            }

            /**
             * Calculates the alpha waves by calculating the average of the frequencies between
             * 7.5Hz and 12.5Hz
             * 
             * @param {Object} fftData The object that contains fftData from OpenBCI-Wifi device
             * @returns {Number} average The average of the frequencies between 7.5Hz and 12.5Hz
             **/
            function getAlphaWaves(fftData) {
                var total = 0;
                var average = 0;
                for (var i = 0; i < fftData.psd[0].length; i++) {
                    total += fftData.psd[0][i];
                }
                average = total / fftData.psd[0].length;
                return average;
            }

            /**
             * Calculates the average of the frequencies between 2Hz and 7Hz that represent eye blinks
             * 
             * @param {Object} fftData The object that contains fftData from OpenBCI-Wifi device
             * @returns {Number} average The average of the frequencies between 2Hz and 7Hz
             **/
            function getAverageForBlinks(fftData) {
                var total = 0;
                var average = 0;
                for (var i = 0; i < fftData.psd[1].length; i++) {
                    total += fftData.psd[1][i];
                }
                average = total / fftData.psd[1].length;
                return average;
            }

            // FUNCTIONS FOR PIE CHART
            /**
             * Plots the pie chart with the frequencies between 7.5Hz and 12.5Hz
             * 
             * @param {Object} pieChart The properties of the pie chart
             * @param {Object} fftData The object that contains fft data from OpenBCI-Wifi device
             **/
            function updatePieChart(pieChart, fftData) {
                for (var i = 0; i < fftData.psd[0].length; i++) {
                    if (tracker === 1) {
                        pieChart.data.datasets[0].data.push(Math.random() * 10);
                    } else {
                        pieChart.data.datasets[0].data[i] = Math.random() * 10;
                    }
                    tracker++;
                }
                pieChart.update();            
            }

            // FUNCTION FOR RAW CHART
            /**
             * Plots the line chart with the raw data in microvolts
             * 
             * @param {Object} rawChart The properties of the pie chart
             * @param {Object} rawData The object that contains raw data from OpenBCI-Wifi device
             **/
            function updateRawChart(rawChart, rawData) {
                var length = 100;
                if (rawChart.data.datasets[0].data.length > length) {
                    rawChart.data.datasets[0].data.shift();
                    rawChart.data.labels.shift();
                }
                rawChart.data.datasets[0].data.push(rawData.data[0]);
                rawChart.data.labels.push(counter++);
                rawChart.update(); 
            }

            // ACCESSORY FUNCTIONS
            /**
             * Calculates the first Exponential Moving Average value
             * 
             * @param {Array} arr The array with number of fft data points and the number is 
             * equal to period
             * @returns {Number} The average of fft data points in the array
             **/
            // first SMA(first average) becomes the first EMA.
            function getFirstEMAVal(arr, period) {
                var total = arr.reduce((a, b) => a + b, 0);
                return total / period;
            }

            /**
             * Calculates the smoothing constant
             * 
             * @param {Number} period The period
             * @returns {Number} The smoothing constant
             **/
            function getSmoothingConstant(period) {
                return 2 / (period + 1);
            }

            /**
             * Calculates the Exponential Moving Average value
             * 
             * @param {Number} curVal The current fft data point
             * @param {Number} prevEMAVal The previous EMA value
             * @param {Number} smoothingConstant The smoothing constant
             * @returns {Number} The next EMA value
             **/
            function getEMA(curVal, prevEMAVal, smoothingConstant) {
                return (curVal - prevEMAVal) * smoothingConstant + prevEMAVal;
            }

            /**
             * Inserts the fft values to the map for obtaining the max frequency index
             * 
             * @param {Object} fftData The object that contains fft data from OpenBCI-Wifi device
             **/
            function pushValstoFreqsMap(fftData, freqsMap) {
                for (var i = 0; i < fftData.psd[0].length; i++) {
                    freqsMap[i.toString()].push(fftData.psd[0][i]);
                }
            }

            /**
             * Determines the max frequency index
             * 
             * @param {Object} fftData The object that contains fft data from OpenBCI-Wifi device
             * @param {Map} freqsMap The map that contains keys of index(frequency) and the 
             *              corresponding array with the fft data points
             **/
            function getMaxFrequencyIndex(fftData, freqsMap) {
                var tempMaxVal = 0;
                for (var i = 0; i < fftData.psd[0].length; i++) {
                    var tempAverage = 0;
                    var total = freqsMap[i.toString()].reduce((a, b) => a + b, 0);
                    tempAverage = total / freqsMap[i.toString()].length;
                    if (tempAverage > tempMaxVal) {
                        tempMaxVal = tempAverage;
                        maxFreqIndex = i;
                        console.log("max frequency index: ", maxFreqIndex);
                    }
                }
            }

            /**
             * Determines the min frequency index
             *
             * @param {Object} fftData The object that contains fft data from OpenBCI-Wifi device
             * @param {Map} freqsMap The map that contains keys of index(frequency) and the 
             *              corresponding array with the fft data points
            **/
            function getMinFrequencyIndex(fftData, freqsMap) {
                var tempMinVal = Number.MAX_SAFE_INTEGER;
                for (var i = 0; i < fftData.psd[0].length; i++) {
                    var tempAverage = 0;
                    var total = freqsMap[i.toString()].reduce((a, b) => a + b, 0);
                    tempAverage = total / freqsMap[i.toString()].length;
                    if (tempAverage < tempMinVal) {
                        tempMinVal = tempAverage;
                        minFreqIndex = i;
                        console.log("min frequency index: ", minFreqIndex);
                    }
                }
            }
        </script>
    </body>   
</html>